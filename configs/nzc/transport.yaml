# Required nodes from outside the framework:
# population
# co2_unit_price
# net_emissions
# total_cost
# Required dimensions from outside the framework:
# ghg
# scope
# transport_mode
# pollutant
# transport_pollutant
# energy_carrier
# stakeholder
# Required parameters from outside the framework:

dimensions:

- id: transport_pollutant
  label: Transport pollutant
  categories:
  - id: co2
    label: CO2
  - id: nox
    label: NOx
  - id: pm25
    label: PM2.5
  - id: pm10
    label: PM10

nodes:
- id: transport_emissions
  name: Transport emissions
  type: simple.EmissionFactorActivity
  quantity: emissions
  unit: kt/a
  color: '#E15759'
  input_dimensions: [transport_mode, ghg, scope, energy_carrier]
  output_dimensions: [transport_mode, ghg, scope, energy_carrier]
  input_nodes:
  - id: vehicle_kilometres
    to_dimensions:
    - id: ghg
      categories: [co2e]
    - id: scope
      categories: [scope1]
    - id: transport_mode
    - id: energy_carrier
  - id: transport_emission_factor
    from_dimensions:
    - id: pollutant
      categories: [co2]
      flatten: true
    to_dimensions:
    - id: transport_mode
    - id: ghg
      categories: [co2e]
    - id: scope
      categories: [scope1]
    - id: energy_carrier
  output_nodes:
  - id: net_emissions
    from_dimensions:
    - id: transport_mode
      flatten: true
    - id: energy_carrier
      categories: [electricity]
      exclude: true
      flatten: true
    to_dimensions:
    - id: sector
      categories: [transport]
    - id: ghg
    - id: scope

# - id: transport_electricity_emissions
#   name: Transport electricity emissions
#   type: simple.AdditiveNode
#   quantity: emissions
#   unit: kt/a
#   input_dimensions: [transport_mode, ghg, scope, energy_carrier]
#   output_dimensions: [transport_mode, ghg, scope, energy_carrier]
#   input_nodes:
#   - id: transport_emissions
#     from_dimensions:
#     - id: energy_carrier
#       categories: [electricity]
  # output_nodes:
  # - id: electricity_emissions
  #   from_dimensions:
  #   - id: transport_mode
  #     flatten: true
  #   - id: energy_carrier
  #     flatten: true

- id: baseline_year_fleet_emission_factor_pre
  name: Baseline year car and bus fleet emission factor before splitting
  description: 'Emission factor is a weighted average of existing and
    new car and bus fleet, where 0.5 * X % is renewed annually (X = share of fleet that is less than 2 years old). Cars are calculated by<br>=L174*(1-M$172)+M164*M$172<br>while buses are calculated by
    =IF(($L242*(1-SUM($L$241:N$241))+N233*SUM($L$241:N$241))>M242,M242,($L242*(1-SUM($L$241:N$241))+N233*SUM($L$241:N$241)))<br>
    There are a few key differences: 1) the existing fleet in the formula is that of year 2018, while with cars it is the previous year; 2) the percentage change is the total from 2018, while with cars it is from the previous year; 3) bus emission factor cannot increase, which would happen if the baseline emission factor (given by the user) would be larger than the new bus emission factor. There differences 1 & 2 are coherent, but it also results in a situation where the cohorts between 2019 and the previous year (inclusive) suddenly disappear and are replaced by current year fleet. However, this is not a problem because new bus fleet does not improve and the emission factors are the same for evary year. Difference 3 is handled (TO BE DISCUSSED!) by replacing the new emission factor with the baseline year value if it is smaller, so that at the actual calculation there is no need to consideer this any more.</p>'
  type: gpc.DatasetNode
  quantity: emission_factor
  unit: g/vkm
  input_dimensions: [transport_pollutant, transport_mode]
  output_dimensions: [transport_pollutant, transport_mode]
  input_datasets:
  - id: nzc/defaults
  params:
    sector: Transport Emission factors

- id: new_fleet_emission_factor_pre
  name: New fleet emission factor before splitting
  description: '<p>Emission factors for new cars following the EURO 6 standard. (EU: Cars and Light Trucks. 
    https://www.dieselnet.com/standards/eu/ld.php)<br>
    This node is needed in vehicle fleet upgrade. The idea is that there are several cohorts i of vehicles, each faving its own emission factor. The first cohort comes from node baseline_year_fleet_emission_factor and it contains all cars that were in the fleet in the baseline. Each year after that, a new cohort of cars enter the fleet, each having the emission factor that was for that year in node new_fleet_emission_factor. Each cohort has a proportion of P<sub>i</sub> among the fleet. The average emission factor is therefore<br>
    E<sub>t</sub> = sum<sub>i</sub>(E<sub>i,t</sub> * P<sub>i,t</sub>) <br>where i is class and t is timepoint. This is complicated by gradual removal of vehicle classes from the fleet such that<br>
    N<sub>i,t</sub> = N<sub>i,t0</sub> * product(s<sub>i,0</sub>, ..., s<sub>i,t</sub>), <br>where s<sub>i,t</sub> are the survival rates, N<sub>i,t</sub> is the number of cars in a cohort at timepoint t, t0 is the timepoint of entry for that cohort, and proportion P<sub>i,t</sub> = N<sub>i,t</sub>/sum<sub>i</sub>(N<sub>i,t</sub>).
    It must be noted that for each timepoint, there are the existing cohorts and a new cohort that enters in that year.</p>
    <p>In this use case, it is important to separate these cohorts because the emission factor is decreasing in time.
    The computation logic is that after a vehicle has entered the fleet, it has the same survival probability as all other
    cars in the fleet. (Not realistic but that is how NZC excel works)</p>
    Finally, we assume that E is constant for each vehicle as long as it is in the fleet. 
    This is handled by looking at each E<sub>i,t</sub> cohort until the last time point.'
  type: gpc.DatasetNode
  quantity: emission_factor
  unit: g/vkm
  input_dimensions: [transport_pollutant, transport_mode]
  output_dimensions: [transport_pollutant, transport_mode]
  input_datasets: [nzc/defaults]
  params:
    sector: new fleet emission factor

- id: transport_pollutant_split
  name: Transport pollutant split
  description: Particulate pollutants (PM2.5 and PM10) are entered as totals by the user. However, calculations are based on a split between combustion pollutants (from tailpipe) and wear & tear (dust from breaks and tyres). This node has the fractions of these subcategories. Note! The NZC excel treats combustion and non-combustion fractions differently. Non-combustion value is taken from the user multiplied by its split fraction and assumed to stay constant across time. Combustion value for new cars comes from an EU report and is assumed to improve over time. The difference is substantial, as the default for current PM10 is 30 mg/vkm, while the new fleet assumes 8 mg/vkm. Here, we use the lower value, which is consistent with the calculation logic.
  type: gpc.DatasetNode
  quantity: fraction
  unit: dimensionless
  input_dimensions: [pollutant, transport_pollutant, energy_carrier]
  output_dimensions: [pollutant, transport_pollutant, energy_carrier]
  input_datasets: [nzc/defaults]
  params:
    sector: transport pollutant split

- id: baseline_year_fleet_emission_factor
  name: Baseline year fleet emission factor
  type: simple.MultiplicativeNode
  quantity: emission_factor
  unit: g/vkm
  input_dimensions: [pollutant, transport_pollutant, transport_mode, energy_carrier]
  output_dimensions: [pollutant, transport_pollutant, transport_mode, energy_carrier]
  input_nodes:
  - id: baseline_year_fleet_emission_factor_pre
    tags: [non_additive]
    to_dimensions:
    - id: transport_pollutant
    - id: transport_mode
  - id: transport_pollutant_split
    to_dimensions:
    - id: pollutant
    - id: transport_pollutant
    - id: energy_carrier

- id: new_fleet_emission_factor
  name: New fleet emission factor
  type: simple.MultiplicativeNode
  quantity: emission_factor
  unit: g/vkm
  input_dimensions: [pollutant, transport_pollutant, transport_mode, energy_carrier]
  output_dimensions: [pollutant, transport_pollutant, transport_mode, energy_carrier]
  input_nodes:
  - id: new_fleet_emission_factor_pre
    tags: [non_additive]
    to_dimensions:
    - id: transport_pollutant
    - id: transport_mode
  - id: transport_pollutant_split
    to_dimensions:
    - id: pollutant
    - id: transport_pollutant
    - id: energy_carrier

- id: old_fleet_removal
  name: Old fleet removal
  type: gpc.DatasetNode
  description: The fraction of current car and bus fleet that is removed each year from the fleet.
  quantity: fraction
  unit: '%/a'
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_datasets: [nzc/defaults]
  params:
  - id: sector
    value: Share of fleet that is less than 2 years old
  - id: multiplier
    value: 0.5
    unit: 1/a

- id: fleet_replacement_rate
  name: Fleet replacement rate
  type: gpc.DatasetNode
  quantity: fraction
  unit: dimensionless
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_datasets: [nzc/defaults]
  params:
  - id: sector
    value: Share of fleet that is less than 2 years old
  - id: multiplier
    value: 0.5
    unit: dimensionless

- id: fleet_emission_factor  #  FIXME Node dilutes too little. Should go 130-->107 2020-->2030 but goes onlt 120 in cars.
  name: Fleet emission factor
  description: Emission factor for the current car and bus fleet. (Assuming there are no diesel trains)
  type: costs.DilutionNode
  quantity: emission_factor
  unit: g/vkm
  input_dimensions: [pollutant, transport_mode, energy_carrier]
  output_dimensions: [pollutant, transport_mode, energy_carrier]
  input_nodes:
  - id: baseline_year_fleet_emission_factor
    tags: [inventory_only, existing]
    from_dimensions:
    - id: transport_pollutant
      flatten: true
  - id: new_fleet_emission_factor
    tags: [incoming]
    from_dimensions:
    - id: transport_pollutant
      flatten: true
  - id: old_fleet_removal
    tags: [removing, inserting, test_tag]
    to_dimensions:
    - id: transport_mode

- id: electric_vehicle_emission_factor
  name: Electric vehicle emission factor
  type: simple.MultiplicativeNode
  quantity: emission_factor
  unit: g/vkm
  input_dimensions: [pollutant, transport_mode, energy_carrier]
  output_dimensions: [pollutant, transport_mode, energy_carrier]
  input_nodes:
  - id: effective_electricity_emission_factor
    to_dimensions:
    - id: pollutant
    - id: energy_carrier
  - id: electricity_efficiency_for_electric_vehicles
    to_dimensions:
    - id: energy_carrier
    - id: transport_mode

- id: transport_emission_factor  # TODO Add wear&tear from electric vehicles
  name: Transport emission factor
  type: simple.AdditiveNode
  quantity: emission_factor
  unit: g/vkm
  input_dimensions: [pollutant, transport_mode, energy_carrier]
  output_dimensions: [pollutant, transport_mode, energy_carrier]
  input_nodes:
  # - id: electric_vehicle_emission_factor
  #   from_dimensions:
  #   - id: transport_mode
  #     categories: [light_trucks, heavy_trucks]
  #     exclude: true
  - id: fleet_emission_factor

- id: transport_air_pollution_emissions
  name: Transport air pollution emissions
  type: simple.MultiplicativeNode # EmissionFactorActivity
  quantity: emissions
  unit: t/a
  input_dimensions: [pollutant, transport_mode, energy_carrier]
  output_dimensions: [pollutant, transport_mode, energy_carrier]
  input_nodes:
  - id: transport_emission_factor
    from_dimensions:
    - id: pollutant
      categories: [pm25_combustion, pm10_combustion, pm25_wear_tear, pm10_wear_tear, nox]
    to_dimensions:
    - id: pollutant
    - id: transport_mode
    - id: energy_carrier
  - id: vehicle_kilometres
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier

- id: vehicle_kilometres
  name: Vehicle kilometres
  type: simple.MultiplicativeNode
  quantity: mileage
  unit: Mvkm/a
  input_dimensions: [transport_mode, energy_carrier]
  output_dimensions: [transport_mode, energy_carrier]
  input_nodes:
  - id: passenger_kilometres
    to_dimensions:
    - id: transport_mode
  - id: transport_efficiency
    to_dimensions:
    - id: transport_mode
    tags: [geometric_inverse]
  - id: transport_energy_carrier_shares

- id: fully_electric_vehicle_share
  name: Fully electric vehicle share historic
  type: gpc.DatasetNode
  quantity: fraction
  unit: '%'
  input_dimensions: [transport_mode, energy_carrier]
  output_dimensions: [transport_mode, energy_carrier]
  input_datasets:
  - id: nzc/defaults
  params:
    sector: Share of fleet fully electric (not including hybrids)

- id: fully_electric_car_share
  name: Fully electric car share
  description: Share of car fleet fully electric (not including hybrids)
  type: gpc.DatasetNode
  quantity: fraction
  unit: '%'
  input_dimensions: [transport_mode, energy_carrier]
  output_dimensions: [transport_mode, energy_carrier]
  input_datasets:
  - id: nzc/defaults
  params:
    sector: Share of fleet fully electric (not including hybrids)

- id: fully_electric_bus_share
  name: Fully electric bus share
  description: Share of bus fleet fully electric (not including hybrids)
  type: gpc.DatasetNode
  quantity: fraction
  unit: '%'
  input_dimensions: [transport_mode, energy_carrier]
  output_dimensions: [transport_mode, energy_carrier]
  input_datasets:
  - id: nzc/defaults
  params:
    sector: Share of bus fleet as fully electric buses (not including hybrids)

- id: number_of_buses_historical
  name: Number of buses historical
  type: gpc.DatasetNode
  quantity: number
  unit: v
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_datasets:
  - id: nzc/defaults
  params:
    sector: Number of buses in city bus fleet

- id: vehicle_kilometres_per_bus
  name: Vehicle kilometres per bus
  type: simple.MultiplicativeNode
  quantity: mileage
  unit: vkm/v/a
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_nodes:
  - id: vehicle_kilometres
    from_dimensions:
    - id: energy_carrier
      flatten: true
    - id: transport_mode
      categories: [buses]
  - id: number_of_buses_historical
    tags: [inventory_only, geometric_inverse]

- id: number_of_buses
  name: Number of buses
  type: simple.MultiplicativeNode
  quantity: number
  unit: vehicles
  input_dimensions: [energy_carrier, transport_mode]
  output_dimensions: [energy_carrier, transport_mode]
  input_nodes:
  - id: vehicle_kilometres
    from_dimensions:
    - id: transport_mode
      categories: [buses]
  - id: vehicle_kilometres_per_bus
    tags: [geometric_inverse, extend_values]
    to_dimensions:
    - id: transport_mode

- id: fully_electric_train_share
  name: Fully electric train share
  description: Share of train fleet fully electric
  type: simple.AdditiveNode
  quantity: fraction
  unit: '%'
  historical_values: [[2018, 100.0], [2023, 100.0]]
  input_dataset_processors: [LinearInterpolation]

- id: transport_energy_carrier_shares
  name: Transport energy carrier shares
  description: Share of fleet fully electric (not including hybrids)
  type: simple.FillNewCategoryNode
  quantity: fraction
  unit: '%'
  input_dimensions: [transport_mode, energy_carrier]
  output_dimensions: [transport_mode, energy_carrier]
  input_nodes:
  - id: fully_electric_car_share
    to_dimensions:
    - id: energy_carrier
    - id: transport_mode
  - id: fully_electric_bus_share
    to_dimensions:
    - id: energy_carrier
    - id: transport_mode
  - id: fully_electric_train_share
    to_dimensions:
    - id: energy_carrier
      categories: [electricity]
    - id: transport_mode
      categories: [trains]
  params:
    new_category: 'energy_carrier:petrol_diesel'

- id: transport_electricity_consumption
  name: Transport electricity consumption
  type: simple.MultiplicativeNode
  quantity: energy
  unit: GWh/a
  input_dimensions: [transport_mode, energy_carrier]
  output_dimensions: [transport_mode, energy_carrier]
  input_nodes:
  - id: vehicle_kilometres
    from_dimensions:
    - id: energy_carrier
      categories: [electricity]
  - id: electricity_efficiency_for_electric_vehicles
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
  output_nodes:
  - id: total_electricity_consumption_uncorr
    from_dimensions:
    - id: transport_mode
      flatten: true
    to_dimensions:
    - id: sector
      categories: [transport]
    - id: energy_carrier

- id: transport_efficiency
  name: Transport efficiency
  type: gpc.DatasetNode
  quantity: occupancy_factor
  unit: passenger/vehicle
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_datasets: [nzc/defaults]
  params:
    sector: Number of passengers per vehicle

- id: passenger_kilometres_data
  name: Passenger kilometres data
  type: gpc.DatasetNode
  quantity: mileage
  unit: Mpkm/a
  input_datasets:
  - id: nzc/defaults
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_nodes:
  - id: population
    tags: [ratio_to_last_historical_value, non_additive]
    to_dimensions: []
  params:
    sector: Transport need

- id: passenger_kilometres_reduced
  name: Passenger kilometres reduced
  type: simple.MultiplicativeNode
  quantity: mileage
  unit: Mpkm/a
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_nodes:
  - id: passenger_kilometres_data
    tags: [non_additive]
  - id: motorised_transport_change
    tags: [arithmetic_inverse]

- id: passenger_kilometres_after_reducing
  name: Passenger kilometres after reducing
  type: simple.AdditiveNode
  quantity: mileage
  unit: Mpkm/a
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_nodes:
  - id: passenger_kilometres_data
  - id: passenger_kilometres_reduced

- id: relative_transport_mode_switches
  name: Relative transport mode switches
  type: gpc.DatasetNode
  quantity: fraction
  unit: '%'
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_datasets: [nzc/defaults]
  params:
    sector: Share of car + motorcycle km reduced shifted towards other modes

- id: passenger_kilometres_switched
  name: Passenger kilometres switched
  type: simple.MultiplicativeNode
  quantity: mileage
  unit: Mpkm/a
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_nodes:
  - id: passenger_kilometres_after_reducing
    tags: [non_additive]
    from_dimensions:
    - id: transport_mode
      categories: [cars]
      flatten: true
    to_dimensions: []
  - id: relative_transport_mode_switches
    to_dimensions:
    - id: transport_mode

- id: passenger_kilometres
  name: Passenger kilometres
  type: simple.AdditiveNode
  quantity: mileage
  unit: Mpkm/a
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_nodes:
  - id: passenger_kilometres_after_reducing
  - id: passenger_kilometres_switched

- id: motorised_transport_index
  name: Motorised transport index
  type: gpc.DatasetNode
  quantity: fraction
  unit: dimensionless
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_datasets: [nzc/defaults]
  params:
    sector: motorised transport index

- id: motorised_transport_change
  name: Motorised transport change
  description: Positive values are reductions in motorised transport.
  type: simple.MultiplicativeNode
  quantity: fraction
  unit: '%'
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_nodes:
  - id: motorised_transport_index
    tags: [non_additive]
    to_dimensions:
    - id: transport_mode

# ---------------- Transport costs ---------------

- id: car_driving_unit_price
  name: Car driving unit price
  type: gpc.DatasetNode
  quantity: unit_price
  unit: EUR/vkm
  input_dimensions: [transport_mode, cost_type]
  output_dimensions: [transport_mode, cost_type]
  input_datasets: [nzc/defaults]
  params:
    sector: Cost of driving a car per kilometre (excluding fuel)

- id: car_driving_costs
  name: Car driving costs (excluding fuel)
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [transport_mode, cost_type, energy_carrier]
  output_dimensions: [transport_mode, cost_type, energy_carrier]
  input_nodes:
  - id: car_driving_unit_price
    from_dimensions:
    - id: cost_type
      categories: [fuel]
      exclude: true
    to_dimensions:
    - id: transport_mode
    - id: cost_type
  - id: vehicle_kilometres
    from_dimensions:
    - id: transport_mode
      categories: [cars]
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
  output_nodes:
  - id: transport_cost
    from_dimensions:
    - id: energy_carrier
      flatten: true
    to_dimensions:
    - id: transport_mode
    - id: cost_type
    - id: stakeholder
      categories: [citizens]

- id: charging_infrastructure_unit_price
  name: Charging infrastructure unit price
  type: gpc.DatasetNode
  quantity: unit_price
  unit: EUR/v
  input_dimensions: [transport_mode, cost_type, energy_carrier]
  output_dimensions: [transport_mode, cost_type, energy_carrier]
  input_datasets: [nzc/defaults]
  params:
    sector: Charging infrastructure costs

- id: charging_infrastructure_shares
  name: Charging infrastructure shares
  type: gpc.DatasetNode
  quantity: fraction
  unit: '%'
  input_dimensions: [transport_mode, cost_type, energy_carrier, stakeholder]
  output_dimensions: [transport_mode, cost_type, energy_carrier, stakeholder]
  input_datasets: [nzc/defaults]
  params:
    sector: ev charging infrastructure

- id: total_number_of_cars  # FIXME Does not change by time
  name: Total number of cars
  type: gpc.DatasetNode
  quantity: number
  unit: vehicle
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_datasets: [nzc/defaults]
  params:
    sector: Total number of cars + motorcycles in city

- id: vehicle_kilometres_per_car
  name: Vehicle kilometres per car
  type: simple.MultiplicativeNode
  quantity: mileage
  unit: vkm/v/a
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_nodes:
  - id: total_number_of_cars
    tags: [geometric_inverse]
  - id: vehicle_kilometres
    tags: [inventory_only]
    from_dimensions:
    - id: energy_carrier
      flatten: true

- id: number_of_new_evs
  name: Number of new EVs
  type: simple.MultiplicativeNode
  quantity: number
  unit: v/a
  input_dimensions: [transport_mode, energy_carrier]
  output_dimensions: [transport_mode, energy_carrier]
  input_nodes:
  - id: vehicle_kilometres
    tags: [difference]
    from_dimensions:
    - id: energy_carrier
      categories: [electricity]
  - id: vehicle_kilometres_per_car
    tags: [geometric_inverse, extend_values]
    to_dimensions:
    - id: transport_mode

- id: charging_infrastructure_costs
  name: Charging infrastructure costs, cars
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [transport_mode, cost_type, energy_carrier, stakeholder]
  output_dimensions: [transport_mode, cost_type, energy_carrier, stakeholder]
  input_nodes:
  - id: charging_infrastructure_unit_price
    tags: [non_additive]
    to_dimensions:
    - id: transport_mode
    - id: cost_type
    - id: energy_carrier
  - id: number_of_new_evs
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
  - id: charging_infrastructure_shares
    from_dimensions:
    - id: cost_type
      flatten: true
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
    - id: stakeholder
  output_nodes:
  - id: transport_cost
    from_dimensions:
    - id: energy_carrier
      flatten: true

- id: charging_infrastructure_costs_buses
  name: Charging infrastructure costs, buses
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [transport_mode, cost_type, energy_carrier, stakeholder]
  output_dimensions: [transport_mode, cost_type, energy_carrier, stakeholder]
  input_nodes:
  - id: charging_infrastructure_unit_price
    tags: [non_additive]
    to_dimensions:
    - id: transport_mode
    - id: cost_type
    - id: energy_carrier
    - id: stakeholder
      categories: [transport_operators]
  - id: number_of_buses
    tags: [difference]
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
  output_nodes:
  - id: transport_cost
    from_dimensions:
    - id: energy_carrier
      flatten: true

- id: total_cost_of_ownership_historical
  name: Total cost of ownership historical
  type: gpc.DatasetNode
  quantity: unit_price
  unit: EUR/vkm
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_datasets: [nzc/defaults]
  params:
    sector: Total cost of ownership

- id: total_cost_of_ownership_shares
  name: Total cost of ownership shares
  type: gpc.DatasetNode
  quantity: fraction
  unit: '%'
  input_dimensions: [cost_type, transport_mode]
  output_dimensions: [cost_type, transport_mode]
  input_datasets: [nzc/defaults]
  params:
    sector: Total cost of ownership shares

- id: total_cost_of_ownership
  name: Total cost of ownership
  type: simple.MultiplicativeNode
  quantity: unit_price
  unit: EUR/vkm
  input_dimensions: [cost_type, transport_mode]
  output_dimensions: [cost_type, transport_mode]
  input_datasets: [nzc/defaults]
  input_nodes:
  - id: total_cost_of_ownership_historical
    tags: [non_additive]
    to_dimensions:
    - id: transport_mode
  - id: total_cost_of_ownership_shares
    to_dimensions:
    - id: transport_mode
    - id: cost_type

- id: transport_ownership_costs
  name: Transport ownership costs
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [cost_type, transport_mode, energy_carrier]
  output_dimensions: [cost_type, transport_mode, energy_carrier]
  input_nodes:
  - id: total_cost_of_ownership
    to_dimensions:
    - id: cost_type
    - id: transport_mode
  - id: vehicle_kilometres
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
  output_nodes:
  - id: transport_cost
    from_dimensions:
    - id: energy_carrier
      flatten: true
    to_dimensions:
    - id: cost_type
    - id: transport_mode
    - id: stakeholder
      categories: [transport_operators]

- id: electric_vehicles_additional_unit_price_historical
  name: Electric vehicles additional unit price historical
  type: gpc.DatasetNode
  quantity: unit_price
  unit: EUR/v
  input_dimensions: [transport_mode, energy_carrier, cost_type]
  output_dimensions: [transport_mode, energy_carrier, cost_type]
  input_datasets: [nzc/defaults]
  params:
    sector: Additional costs for electric vehicles

- id: electric_vehicles_unit_price_rate
  name: Electric vehicles additional unit price rate
  type: gpc.DatasetNode
  quantity: rate
  unit: '%/a'
  input_dimensions: [transport_mode, energy_carrier, cost_type]
  output_dimensions: [transport_mode, energy_carrier, cost_type]
  input_datasets: [nzc/defaults]
  params:
    sector: Additional costs for electric vehicles rate

- id: electric_vehicles_additional_unit_price
  name: Electric vehicles additional unit price
  type: simple.MultiplicativeNode
  quantity: unit_price
  unit: EUR/v
  input_dimensions: [transport_mode, energy_carrier, cost_type]
  output_dimensions: [transport_mode, energy_carrier, cost_type]
  input_nodes:
  - id: electric_vehicles_additional_unit_price_historical
    tags: [non_additive]
  - id: electric_vehicles_unit_price_rate
    tags: [arithmetic_inverse, complement_cumulative_product]

- id: additional_cost_of_buying_electric_vehicles
  name: Additional cost of buying electric vehicles
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [transport_mode, energy_carrier, cost_type, stakeholder]
  output_dimensions: [transport_mode, energy_carrier, cost_type, stakeholder]
  input_nodes:
  - id: electric_vehicles_additional_unit_price
    from_dimensions:  # FIXME
    - id: cost_type
      flatten: true
    to_dimensions:
    - id: cost_type
      categories: [capex]
    - id: transport_mode
    - id: energy_carrier
  - id: number_of_new_evs
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
  - id: up_front_cost_shares_of_evs
  output_nodes:
  - id: transport_cost
    from_dimensions:
    - id: energy_carrier
      flatten: true
    to_dimensions:
    - id: stakeholder
    - id: transport_mode
    - id: cost_type

- id: additional_cost_of_buying_electric_buses
  name: Additional cost of buying electric buses
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [transport_mode, energy_carrier, cost_type]
  output_dimensions: [transport_mode, energy_carrier, cost_type]
  input_nodes:
  - id: electric_vehicles_additional_unit_price
    from_dimensions:
    - id: transport_mode
      categories: [buses]
  - id: number_of_buses
    tags: [difference]
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
  output_nodes:
  - id: transport_cost
    from_dimensions:
    - id: energy_carrier
      flatten: true
    to_dimensions:
    - id: stakeholder
      categories: [transport_operators]
    - id: transport_mode
    - id: cost_type

- id: electricity_efficiency_for_electric_vehicles
  name: Electricity efficiency for electric vehicles
  type: gpc.DatasetNode
  quantity: energy_factor
  unit: kWh/vkm
  input_dimensions: [transport_mode, energy_carrier]
  output_dimensions: [transport_mode, energy_carrier]
  input_datasets: [nzc/defaults]
  params:
    sector: Electricity consumption average vehicle

- id: up_front_cost_shares_of_evs
  name: Up-front cost shares of EVs
  type: gpc.DatasetNode
  quantity: fraction
  unit: '%'
  input_dimensions: [transport_mode, energy_carrier, stakeholder, cost_type]
  output_dimensions: [transport_mode, energy_carrier, stakeholder, cost_type]
  input_datasets: [nzc/defaults]
  params:
    sector: up-front costs for EVs

- id: air_pollution_unit_price
  name: Air pollution unit price
  description: 'Unit prices for air pollutants, noise, accidents, and CO2 come from a single source
    (Essen et al., 2019). Datasets can be created from 1.1 Reduce transport need G129:G134 (CO2 and air pollutants),
    G169:G179 (noise), G204:G209 (accidents). The values are constant across time.
    <h2>References</h2><ul><li>Essen et. al. (2019). Handbook on the external costs of transport. 
    For European Commission Directorate-General for Mobility and Transport</li></ul>'
  type: gpc.DatasetNode
  quantity: unit_price
  unit: EUR/t
  input_dimensions: [pollutant, cost_type, area_distance]
  output_dimensions: [pollutant, cost_type, area_distance]
  input_datasets: [nzc/defaults]
  params:
    sector: Air pollution unit price

- id: transport_air_pollution_costs
  name: Transport air pollution costs
  description: TODO Air pollution costs also include CO2 even if it is calculated elsewhere. This results in double counting. CO2 should be removed from here.
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [stakeholder, pollutant, transport_mode, cost_type]
  output_dimensions: [stakeholder, pollutant, transport_mode, cost_type]
  input_nodes:
  - id: air_pollution_unit_price
    from_dimensions:
    - id: area_distance
      categories: [inside]  # FIXME Check PM10: Does it drop out?
      flatten: true
    to_dimensions:
    - id: cost_type
    - id: pollutant
  - id: transport_air_pollution_emissions
    from_dimensions:
    - id: energy_carrier
      flatten: true
    to_dimensions:
    - id: transport_mode
    - id: pollutant
  - id: co_benefit_cost_shares
    to_dimensions:
    - id: cost_type
    - id: stakeholder
  output_nodes:
  - id: transport_cost
    from_dimensions:
    - id: pollutant
      flatten: true
    to_dimensions:
    - id: cost_type
    - id: stakeholder
    - id: transport_mode

- id: transport_noise_unit_price
  name: Transport noise unit price
  type: gpc.DatasetNode
  quantity: unit_price
  unit: EUR/pkm
  input_dimensions: [transport_mode, cost_type]
  output_dimensions: [transport_mode, cost_type]
  input_datasets: [nzc/defaults]
  params:
    sector: Noise

- id: transport_noise_unit_price_per_vkm
  name: Transport noise unit price per vehicle km
  type: simple.MultiplicativeNode
  quantity: unit_price
  unit: EUR/vkm
  input_dimensions: [transport_mode, cost_type]
  output_dimensions: [transport_mode, cost_type]
  input_nodes:
  - id: transport_noise_unit_price
  - id: transport_efficiency
    tags: [inventory_only, extend_values]
    to_dimensions:
    - id: transport_mode

- id: co_benefit_cost_shares
  name: Co-benefit cost shares
  type: gpc.DatasetNode
  quantity: fraction
  unit: dimensionless
  input_dimensions: [stakeholder, cost_type]
  output_dimensions: [stakeholder, cost_type]
  input_datasets: [nzc/defaults]
  params:
    sector: distribution of co-benefits

- id: transport_noise_cost
  name: Transport noise cost
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [stakeholder, transport_mode, cost_type]
  output_dimensions: [stakeholder, transport_mode, cost_type]
  input_nodes:
  - id: transport_noise_unit_price_per_vkm
    to_dimensions:
    - id: cost_type
    - id: transport_mode
  - id: vehicle_kilometres
    from_dimensions:
    - id: energy_carrier
      flatten: true
    to_dimensions:
    - id: transport_mode
  - id: co_benefit_cost_shares
    to_dimensions:
    - id: stakeholder
    - id: cost_type
  output_nodes:
  - id: transport_cost
    to_dimensions:
    - id: transport_mode
    - id: stakeholder
    - id: cost_type

- id: transport_accident_unit_price
  name: Transport accident unit price
  type: gpc.DatasetNode
  quantity: unit_price
  unit: EUR/pkm
  input_dimensions: [transport_mode, cost_type]
  output_dimensions: [transport_mode, cost_type]
  input_datasets: [nzc/defaults]
  params:
    sector: Traffic accidents

- id: transport_accident_unit_price_per_vkm
  name: Transport accident unit price per vehicle km
  type: simple.MultiplicativeNode
  quantity: unit_price
  unit: EUR/vkm
  input_dimensions: [transport_mode, cost_type]
  output_dimensions: [transport_mode, cost_type]
  input_nodes:
  - id: transport_accident_unit_price
  - id: transport_efficiency
    tags: [inventory_only, extend_values]
    to_dimensions:
    - id: transport_mode

- id: transport_accident_cost
  name: Transport accident cost
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [stakeholder, transport_mode, cost_type]
  output_dimensions: [stakeholder, transport_mode, cost_type]
  input_nodes:
  - id: transport_accident_unit_price_per_vkm
    to_dimensions:
    - id: transport_mode
    - id: cost_type
  - id: vehicle_kilometres
    from_dimensions:
    - id: energy_carrier
      flatten: true
    to_dimensions:
    - id: transport_mode
  - id: co_benefit_cost_shares
    to_dimensions:
    - id: stakeholder
    - id: cost_type
  output_nodes:
  - id: transport_cost
    to_dimensions:
    - id: stakeholder
    - id: transport_mode
    - id: cost_type

- id: public_transport_operation_unit_price
  name: Public transport operation unit price
  description: Operational costs of buses and trains come from Sveriges kommuner och landsting (2017)
    and values are at 1.1 Reduce transport need G236:G241. The values are constant across time.
    <h2>References</h2><ul><li>Essen et. al. (2019). Handbook on the external costs of transport. 
    For European Commission Directorate-General for Mobility and Transport</li>
    <li>Sveriges kommuner och landsting (2017). Kollektivtrafikens kostnadsutveckling – en överblick. https://webbutik.skl.se/sv/artiklar/kollektivtrafikens-kostnadsutveckling-en-overblick.html</li></ul>'
  # type: gpc.DatasetNode
  type: simple.AdditiveNode
  quantity: unit_price
  unit: EUR/vkm
  historical_values: [[2018, 0.32]]
  # # input_dimensions: [transport_mode, cost_type]
  # # output_dimensions: [transport_mode, cost_type]
  # input_datasets: [nzc/defaults]
  # params:
  #   sector: public transport operation unit price

- id: public_transport_operation_cost_shares
  name: Public transport operation cost shares
  description: See transport_air_pollution_cost_shares
  type: gpc.DatasetNode
  quantity: fraction
  unit: dimensionless
  input_dimensions: [stakeholder, cost_type, transport_mode]
  output_dimensions: [stakeholder, cost_type, transport_mode]
  input_datasets:
  - id: nzc/defaults
  params:
    sector: public transport operation costs

- id: public_transport_operation_cost
  name: Public transport operation cost (excluding fuel)
  description: Operation cost to all stakeholders.
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [transport_mode, stakeholder, cost_type]
  output_dimensions: [transport_mode, stakeholder, cost_type]
  input_nodes:
  - id: public_transport_operation_unit_price
    to_dimensions:
    - id: transport_mode
      categories: [buses]  # FIXME
    - id: cost_type
      categories: [opex]  # FIXME
  - id: vehicle_kilometres
    from_dimensions:
    - id: energy_carrier  # FIXME Check that the costs are the same for electric buses
      flatten: true
    - id: transport_mode
      categories: [buses, trains]
    to_dimensions:
    - id: transport_mode
  - id: public_transport_operation_cost_shares
    from_dimensions:
    - id: transport_mode
      categories: [public_transport]
      flatten: true
    to_dimensions:
    - id: stakeholder
    - id: cost_type
  output_nodes:
  - id: transport_cost
    to_dimensions:
    - id: transport_mode
    - id: stakeholder
    - id: cost_type

- id: transport_energy_factor_ice_petrol_diesel
  name: Transport energy factor - ICE petrol/diesel
  description: Values come from European Commission (2019) and are found from 1.1 Reduce transport need G266.
    <h2>References</h2>
    European commission (2019) - Reducing CO2 emissions from passenger cars.
    https://ec.europa.eu/clima/policies/transport/vehicles/cars_en
  type: gpc.DatasetNode
  quantity: emission_factor
  unit: l/g
  input_datasets: [nzc/defaults]
  params:
    sector: transport energy factor ice petrol diesel

- id: bus_mileage
  name: Bus mileage (fuel use)
  type: gpc.DatasetNode
  quantity: energy_factor
  unit: l/vkm
  input_dimensions: [transport_mode, energy_carrier]
  output_dimensions: [transport_mode, energy_carrier]
  input_datasets: [nzc/defaults]
  output_nodes:
  - id: vehicle_mileage
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
    - id: stakeholder
      categories: [transport_operators]
  params:
    sector: Average fuel consumption of buses, based on current fleet

- id: fuel_unit_price
  name: Fuel unit price
  description: The values come from Eurostat (2019) - Electricity prices for household consumers
    and are found from MIA D430.
  type: gpc.DatasetNode
  quantity: unit_price
  unit: EUR/l
  input_dimensions: [cost_type]
  output_dimensions: [cost_type]
  input_datasets: [nzc/defaults]
  params:
    sector: fuel unit price

- id: vehicle_mileage
  name: Vehicle mileage (fuel use)
  type: simple.MultiplicativeNode
  quantity: currency
  unit: l/vkm
  input_dimensions: [transport_mode, energy_carrier, stakeholder]
  output_dimensions: [transport_mode, energy_carrier, stakeholder]
  input_nodes:
  - id: transport_emission_factor
    from_dimensions:
    - id: pollutant
      categories: [co2]
      flatten: true
    - id: energy_carrier
      categories: [petrol_diesel]
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
  - id: transport_energy_factor_ice_petrol_diesel
    to_dimensions:
    - id: transport_mode
      categories: [cars]
    - id: stakeholder
      categories: [citizens]

- id: transport_fuel_cost
  name: Transport fuel cost
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [stakeholder, transport_mode, cost_type, energy_carrier]
  output_dimensions: [stakeholder, transport_mode, cost_type, energy_carrier]
  input_nodes:
  - id: vehicle_mileage
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
    - id: stakeholder
  - id: vehicle_kilometres
    to_dimensions:
    - id: transport_mode
    - id: energy_carrier
  - id: fuel_unit_price
    to_dimensions:
    - id: cost_type
  output_nodes:
  - id: transport_cost
    from_dimensions:
    - id: energy_carrier
      flatten: true
    to_dimensions:
    - id: stakeholder
    - id: transport_mode
    - id: cost_type

- id: walking_cycling_unit_price1
  name: Walking & cycling unit price, co-benefits
  type: gpc.DatasetNode
  quantity: unit_price
  unit: EUR/pkm
  input_datasets: [nzc/defaults]
  input_dimensions: [transport_mode, cost_type]
  output_dimensions: [transport_mode, cost_type]
  params:
    sector: Average value of increased walking/cycling

- id: walking_cycling_unit_price2
  name: Walking & cycling unit price, capex
  type: gpc.DatasetNode
  quantity: unit_price
  unit: EUR/pkm
  input_datasets: [nzc/defaults]
  input_dimensions: [transport_mode, cost_type]
  output_dimensions: [transport_mode, cost_type]
  params:
    sector: Total Average cost of cycling/walking

- id: walking_cycling_unit_price
  name: Walking & cycling unit price
  type: simple.AdditiveNode
  quantity: unit_price
  unit: EUR/pkm
  input_dimensions: [transport_mode, cost_type]
  output_dimensions: [transport_mode, cost_type]
  input_nodes:
  - id: walking_cycling_unit_price1
  - id: walking_cycling_unit_price2
    to_dimensions:
    - id: transport_mode
    - id: cost_type

- id: walking_cycling_co_benefit
  name: Walking & cycling co-benefit
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [stakeholder, transport_mode, cost_type]
  output_dimensions: [stakeholder, transport_mode, cost_type]
  input_nodes:
  - id: walking_cycling_unit_price1
    tags: [arithmetic_inverse]
    to_dimensions:
    - id: transport_mode
    - id: cost_type
  - id: co_benefit_cost_shares
    to_dimensions:
    - id: cost_type
    - id: stakeholder
  - id: passenger_kilometres
    to_dimensions:
    - id: transport_mode
  output_nodes: [transport_cost]

- id: walking_cycling_cost_shares
  name: Walking & cycling cost shares, capex
  type: gpc.DatasetNode
  quantity: fraction
  unit: dimensionless
  input_datasets: [nzc/defaults]
  input_dimensions: [transport_mode, cost_type, stakeholder]
  output_dimensions: [transport_mode, cost_type, stakeholder]
  params:
    sector: investment costs in walking & cycling

- id: walking_cycling_cost
  name: Walking & cycling cost
  type: simple.MultiplicativeNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [stakeholder, transport_mode, cost_type]
  output_dimensions: [stakeholder, transport_mode, cost_type]
  input_nodes:
  - id: walking_cycling_unit_price2
    to_dimensions:
    - id: transport_mode
    - id: cost_type
  - id: walking_cycling_cost_shares
  - id: passenger_kilometres
    to_dimensions:
    - id: transport_mode
  output_nodes: [transport_cost]

- id: transport_cost
  name: Transport cost
  type: simple.AdditiveNode
  quantity: currency
  unit: MEUR/a
  input_dimensions: [stakeholder, transport_mode, cost_type]
  output_dimensions: [stakeholder, transport_mode, cost_type]
  output_nodes:
  - id: total_cost
    from_dimensions:
    - id: transport_mode
      flatten: true
    to_dimensions:
    - id: cost_type
    - id: stakeholder

- id: transport_mode_fraction
  name: Transport mode fraction
  type: simple.MixNode
  quantity: mix
  unit: '%'
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_nodes:
  - id: passenger_kilometres_data
    tags: activity

- id: relative_transport_efficiency
  name: Relative transport efficiency
  type: gpc.DatasetNode
  quantity: ratio
  unit: '%'
  input_dimensions: [transport_mode]
  output_dimensions: [transport_mode]
  input_datasets: [nzc/defaults]
  output_nodes:
  - id: transport_efficiency
    tags: [non_additive]
  params:
    sector: relative transport efficiency

- id: electrification_year_of_transport
  name: Electrification year of passenger cars
  type: gpc.DatasetNode
  quantity: fraction
  unit: dimensionless
  input_dimensions: [transport_mode, energy_carrier]
  output_dimensions: [transport_mode, energy_carrier]
  input_datasets:
  - id: nzc/defaults
    filters:
    - column: Parameter
      value: Max year
  params:
    sector: Electrification of transport fleet
